---
version: '2'

tasks:
    up:
        desc: "Start application"
        cmds:
            - docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d
            - docker-compose -f docker-compose.yml -f docker-compose.dev.yml exec -uwww-data app composer install
            - docker-compose -f docker-compose.yml -f docker-compose.dev.yml exec -uwww-data app bin/console doctrine:migrations:migrate -n

    restart:
        desc: "Restart application"
        cmds:
            - docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d --build --remove-orphans
            - docker-compose -f docker-compose.yml -f docker-compose.dev.yml exec -uwww-data app composer install
            - docker-compose -f docker-compose.yml -f docker-compose.dev.yml exec -uwww-data app bin/console doctrine:migrations:migrate -n

    down:
        desc: "Stop application"
        cmds:
            - docker-compose -f docker-compose.yml -f docker-compose.dev.yml down --remove-orphans

    sh:
        desc: "Jump into app container"
        cmds:
            - docker-compose -f docker-compose.yml -f docker-compose.dev.yml exec -uwww-data app sh

    test:
        desc: "Run tests"
        cmds:
            - docker-compose -f docker-compose.yml -f docker-compose.dev.yml -f docker-compose.test.yml up -d
            - docker-compose -f docker-compose.yml -f docker-compose.dev.yml -f docker-compose.test.yml exec -uwww-data test bin/console doctrine:database:create --if-not-exists -vvv
            - docker-compose -f docker-compose.yml -f docker-compose.dev.yml -f docker-compose.test.yml exec -uwww-data test bin/console doctrine:migration:migrate --env=test -n -vvv
            - docker-compose -f docker-compose.yml -f docker-compose.dev.yml -f docker-compose.test.yml exec -uwww-data test bin/console doctrine:fixtures:load --purge-with-truncate -n --env=test -vvv
            - cmd: docker-compose -f docker-compose.yml -f docker-compose.dev.yml -f docker-compose.test.yml exec -uwww-data test vendor/bin/codecept run --steps -v
              ignore_error: true
            - docker-compose -f docker-compose.yml -f docker-compose.dev.yml -f docker-compose.test.yml stop test